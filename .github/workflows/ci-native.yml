name: Native CI

on:
  push:
  pull_request:
  workflow_dispatch:

concurrency:
  group: native-ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  native-linux-ffmpeg:
    name: native (ubuntu, FFmpeg)
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            pkg-config \
            libasound2-dev \
            libjack-jackd2-dev \
            libavformat-dev \
            libavcodec-dev \
            libavutil-dev \
            libswresample-dev

      - name: Install MoonBit
        shell: bash
        run: |
          set -euo pipefail
          curl -fsSL https://cli.moonbitlang.com/install/unix.sh | bash
          echo "$HOME/.moon/bin" >> "$GITHUB_PATH"

      - name: Verify FFmpeg prebuild detection
        shell: bash
        run: |
          set -euo pipefail
          build_json="$(node build.js)"
          echo "$build_json"
          echo "$build_json" | grep -q "MOON_RODIO_ENABLE_FFMPEG=1"

      - name: Native test
        shell: bash
        run: |
          set -euo pipefail
          moon version --all
          moon update
          moon test --target native

  native-windows-ffmpeg:
    name: native (windows, FFmpeg)
    runs-on: windows-latest
    timeout-minutes: 35
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install MoonBit
        shell: pwsh
        run: |
          iwr -useb https://cli.moonbitlang.com/install/powershell.ps1 | iex
          $mb = "$env:USERPROFILE\.moon\bin"
          $mb | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          $env:PATH = "$mb;$env:PATH"
          moon version

      - name: Install FFmpeg dev package (pinned prebuilt)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $ffmpegVersion = "8.0.1"
          $ffmpegAsset = "ffmpeg-8.0.1-full_build-shared.zip"
          $ffmpegSha256 = "e4a40b46e3a3f3e5f2ed28352bd1fd6c733ae3808a8743682ef7f0d4e20c7d51"
          $ffmpegUrl = "https://github.com/GyanD/codexffmpeg/releases/download/$ffmpegVersion/$ffmpegAsset"

          $downloadRoot = Join-Path $env:RUNNER_TEMP "ffmpeg-download"
          $extractRoot = Join-Path $env:RUNNER_TEMP "ffmpeg-extract"
          New-Item -ItemType Directory -Force -Path $downloadRoot | Out-Null
          New-Item -ItemType Directory -Force -Path $extractRoot | Out-Null
          $archive = Join-Path $downloadRoot $ffmpegAsset

          $downloadOk = $false
          for ($attempt = 1; $attempt -le 3; $attempt++) {
            try {
              if (Test-Path $archive) {
                Remove-Item -Force $archive
              }
              Write-Host "Downloading $ffmpegAsset (attempt $attempt/3)"
              Invoke-WebRequest -Uri $ffmpegUrl -OutFile $archive -MaximumRetryCount 3 -RetryIntervalSec 5
              $actualSha256 = (Get-FileHash -Path $archive -Algorithm SHA256).Hash.ToLowerInvariant()
              if ($actualSha256 -ne $ffmpegSha256) {
                throw "SHA256 mismatch. expected=$ffmpegSha256 actual=$actualSha256"
              }
              $downloadOk = $true
              break
            } catch {
              if ($attempt -eq 3) {
                throw
              }
              Start-Sleep -Seconds (10 * $attempt)
            }
          }
          if (-not $downloadOk) {
            throw "Failed to download and verify $ffmpegAsset"
          }

          Expand-Archive -Path $archive -DestinationPath $extractRoot -Force

          $root = Join-Path $extractRoot "ffmpeg-8.0.1-full_build-shared"
          if (-not (Test-Path $root)) {
            $dirs = @(Get-ChildItem -Path $extractRoot -Directory)
            if ($dirs.Count -ne 1) {
              throw "Unexpected FFmpeg archive layout under $extractRoot"
            }
            $root = $dirs[0].FullName
          }

          $inc = Join-Path $root "include"
          $lib = Join-Path $root "lib"
          $bin = Join-Path $root "bin"
          $requiredPaths = @(
            (Join-Path (Join-Path $inc "libavformat") "avformat.h"),
            (Join-Path (Join-Path $inc "libavcodec") "avcodec.h"),
            (Join-Path (Join-Path $inc "libavutil") "avutil.h"),
            (Join-Path (Join-Path $inc "libswresample") "swresample.h"),
            (Join-Path $lib "avformat.lib"),
            (Join-Path $lib "avcodec.lib"),
            (Join-Path $lib "avutil.lib"),
            (Join-Path $lib "swresample.lib"),
            (Join-Path $bin "ffmpeg.exe")
          )
          foreach ($requiredPath in $requiredPaths) {
            if (-not (Test-Path $requiredPath)) {
              throw "Required FFmpeg file missing: $requiredPath"
            }
          }

          & (Join-Path $bin "ffmpeg.exe") -version | Select-Object -First 1 | Write-Host

          $incUnix = $inc.Replace("\", "/")
          $libUnix = $lib.Replace("\", "/")
          "MOON_RODIO_FFMPEG_CFLAGS=-I$incUnix" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "MOON_RODIO_FFMPEG_LIBS=/LIBPATH:$libUnix avformat.lib avcodec.lib avutil.lib swresample.lib" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          $bin | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Verify FFmpeg prebuild detection
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $json = node build.js
          $json | Write-Host
          if ($json -notmatch "MOON_RODIO_ENABLE_FFMPEG=1") {
            throw "FFmpeg backend was not enabled by build.js"
          }

      - name: Set up MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Native test
        shell: pwsh
        env:
          CC: cl
          CXX: cl
          AR: lib
        run: |
          moon version --all
          moon update
          moon test --target native
